<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tivora — Host</title>
<style>
  :root{--bg:#faf7ff;--panel:#fff;--ink:#0b0d18;--muted:#6b7280;--border:#ebe8f2;--accent:#6e4cff;--radius:16px;--shadow:0 10px 30px rgba(20,20,40,.06)}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:600 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border)}
  .nav{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#7d5cff,#9e94ff)}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  main{max-width:1100px;margin:22px auto;padding:0 16px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  h2{margin:0 0 10px;font-size:22px} .row{display:flex;gap:10px;flex-wrap:wrap}
  select,input,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent);cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .bigcode{font-size:42px;letter-spacing:6px;text-align:center;margin:6px 0}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .muted{color:var(--muted)} .qbox{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px}
  .err{background:#fff3f3;border:1px solid #ffcfcf;color:#8b1a1a;padding:10px;border-radius:12px;display:none}
  .ok{color:#22a06b;font-weight:700}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="logo"></div>Tivora — Host</div>
    <a href="./index.html">Landing</a>
    <a href="./home.html">Home</a>
    <a href="./player.html">Player Page</a>
  </div>
</header>

<!-- Load sets; we have a fallback if this file is missing -->
<script src="./question_sets.js"></script>

<main>
  <!-- Create -->
  <section class="card" id="creator">
    <h2>Create a Game</h2>
    <div id="err" class="err"></div>
    <div class="row">
      <input id="hostName" placeholder="Host name (optional)" />
      <select id="setSel"></select>
      <select id="modeSel">
        <option value="basic">Basic (Points on correct)</option>
      </select>
      <button class="primary" id="createBtn">Create Game</button>
    </div>
    <div class="muted">Pick a set and gamemode, then create the room. You’ll get a 6-digit code.</div>
  </section>

  <!-- Lobby -->
  <section class="card" id="lobbyCard" style="display:none">
    <h2>Lobby</h2>
    <div class="bigcode" id="roomCode">— — — — — —</div>
    <div class="row">
      <button id="copyLinkBtn">Copy Player Link</button>
      <span class="muted" id="joinCount">0 player(s) connected</span>
      <span class="muted">•</span>
      <span class="ok" id="fbOk" style="display:none">Connected</span>
    </div>

    <div class="qbox">
      <div class="muted">Players</div>
      <table>
        <thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead>
        <tbody id="boardBody"></tbody>
      </table>
    </div>

    <div class="row">
      <button id="startBtn" class="primary">Start Game</button>
      <button id="endBtn">End Game</button>
    </div>
  </section>

  <!-- Host control during game -->
  <section class="card" id="controlCard" style="display:none">
    <h2>Host Controls</h2>
    <div class="qbox" id="qArea">
      <div id="qTitle" class="muted">Press “Next Question”.</div>
      <ol id="qChoices" style="margin:8px 0 0 18px"></ol>
    </div>
    <div class="row">
      <button id="nextBtn" class="primary" disabled>Next Question</button>
      <button id="backToLobbyBtn">Back to Lobby</button>
    </div>
  </section>
</main>

<script type="module">
/* Firebase via CDN (works on GitHub Pages) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc,
  collection, serverTimestamp, query, orderBy, where, runTransaction
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* Your Firebase project config */
const firebaseConfig = {
  apiKey: "AIzaSyAHEhrgIPv_mwYTABBcqFCn0J9jrZIEx1Q",
  authDomain: "tivora-6f934.firebaseapp.com",
  databaseURL: "https://tivora-6f934-default-rtdb.firebaseio.com",
  projectId: "tivora-6f934",
  storageBucket: "tivora-6f934.firebasestorage.app",
  messagingSenderId: "329631706099",
  appId: "1:329631706099:web:d4b5bbd429208656510086",
  measurementId: "G-YVPVNVNHH9"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ---------- Helpers & UI ---------- */
const $ = s=>document.querySelector(s);
const errBox = $("#err");
const ui = {
  creator: $("#creator"),
  lobbyCard: $("#lobbyCard"),
  controlCard: $("#controlCard"),
  // creator
  hostName: $("#hostName"),
  setSel: $("#setSel"),
  modeSel: $("#modeSel"),
  createBtn: $("#createBtn"),
  // lobby
  roomCode: $("#roomCode"),
  copyLinkBtn: $("#copyLinkBtn"),
  joinCount: $("#joinCount"),
  boardBody: $("#boardBody"),
  startBtn: $("#startBtn"),
  endBtn: $("#endBtn"),
  fbOk: $("#fbOk"),
  // control
  qTitle: $("#qTitle"),
  qChoices: $("#qChoices"),
  nextBtn: $("#nextBtn"),
  backToLobbyBtn: $("#backToLobbyBtn")
};
function showErr(msg){ errBox.style.display=""; errBox.textContent=msg; console.error(msg); }
function hideErr(){ errBox.style.display="none"; errBox.textContent=""; }

const FALLBACK_SETS = [
  { id:"demo-math", name:"Quick Math", questions:[
    {q:"2 + 2 = ?", choices:["3","4","5"], correct:1},
    {q:"5 × 3 = ?", choices:["8","15","10"], correct:1},
    {q:"9 − 4 = ?", choices:["4","5","6"], correct:1}
  ]}
];
const SETS = (Array.isArray(window.TIVORA_SETS) && window.TIVORA_SETS.length) ? window.TIVORA_SETS : FALLBACK_SETS;
SETS.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; ui.setSel.appendChild(o); });
const getSetById = id => SETS.find(s=>s.id===id);

/* ---------- Room state ---------- */
let roomRef=null, code=null, currentSet=null, round=0, stopPlayers=null, stopRoomSnap=null, stopAnswers=null;

/* ---------- Create flow ---------- */
ui.createBtn.onclick = async ()=>{
  hideErr();
  try{
    currentSet = getSetById(ui.setSel.value);
    if(!currentSet){ showErr("Pick a set first."); return; }

    code = genCode(6);
    roomRef = doc(db, "rooms", code);

    await setDoc(roomRef, {
      mode: ui.modeSel.value,
      setId: currentSet.id,
      hostName: ui.hostName.value || "Host",
      status: "lobby",       // <- lobby until you click Start
      round: 0,
      createdAt: serverTimestamp()
    });

    // Immediately reveal lobby UI (code + players)
    ui.roomCode.textContent = code;
    ui.creator.style.display = "";
    ui.lobbyCard.style.display = "";
    ui.controlCard.style.display = ""; // visible, but Next disabled until Start
    ui.nextBtn.disabled = true;

    // live players/leaderboard
    if(stopPlayers) stopPlayers();
    const playersQ = query(collection(roomRef, "players"), orderBy("score","desc"));
    stopPlayers = onSnapshot(playersQ, snap=>{
      const rows=[];
      snap.forEach(d=>rows.push({id:d.id, ...d.data()}));
      ui.joinCount.textContent = `${rows.length} player(s) connected`;
      ui.boardBody.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name||"Player")}</td><td>${r.score||0}</td></tr>`).join("");
      ui.fbOk.style.display = ""; // we’re getting snapshots, so connection is OK
    }, err=> showErr("Players stream error: "+err.message));

    // keep round/status in sync (e.g., if you open another host tab)
    if(stopRoomSnap) stopRoomSnap();
    stopRoomSnap = onSnapshot(roomRef, snap=>{
      const data = snap.data(); if(!data) return;
      round = data.round|0;
      if(data.status==="lobby"){
        ui.nextBtn.disabled = true;
        ui.qTitle.textContent = "Waiting in lobby. Click Start when ready.";
        ui.qChoices.innerHTML = "";
      } else if(data.status==="question" && data.question){
        ui.nextBtn.disabled = false;
        ui.qTitle.textContent = `Q${data.question.n}: ${data.question.q}`;
        ui.qChoices.innerHTML = data.question.choices.map((c,i)=>`<li>${escapeHtml(c)}${i===data.question.answerIndex?" ✓":""}</li>`).join("");
      } else if(data.status==="started"){
        // Started but no question yet
        ui.nextBtn.disabled = false;
        ui.qTitle.textContent = "Game started. Press Next Question.";
        ui.qChoices.innerHTML = "";
      } else if(data.status==="ended"){
        ui.nextBtn.disabled = true;
        ui.qTitle.textContent = "Game ended.";
        ui.qChoices.innerHTML = "";
      }
    }, err=> showErr("Room stream error: "+err.message));

  }catch(err){
    showErr("Create Game failed: "+ (err?.message||err));
  }
};

/* ---------- Lobby actions ---------- */
ui.copyLinkBtn.onclick = async ()=>{
  try{
    const url = `${location.origin}${location.pathname.replace("host.html","")}player.html?code=${code||''}`;
    await navigator.clipboard.writeText(url);
    alert("Copied join link:\n"+url);
  }catch(err){ showErr("Clipboard error: "+err.message); }
};

ui.startBtn.onclick = async ()=>{
  try{
    if(!roomRef) return showErr("No room created yet.");
    await updateDoc(roomRef, { status: "started", round: 0 });
    ui.nextBtn.disabled = false; // you can now send first question
  }catch(err){ showErr("Start Game failed: "+err.message); }
};

ui.backToLobbyBtn.onclick = async ()=>{
  try{
    if(!roomRef) return;
    await updateDoc(roomRef, { status:"lobby", round: 0, question: null });
  }catch(err){ showErr("Back to Lobby failed: "+err.message); }
};

ui.endBtn.onclick = async ()=>{
  try{
    if(!roomRef) return;
    await updateDoc(roomRef, { status:"ended" });
    if(stopAnswers) stopAnswers();
    alert("Game ended.");
  }catch(err){ showErr("End Game failed: "+err.message); }
};

/* ---------- Questions ---------- */
ui.nextBtn.onclick = async ()=>{
  try{
    if(!roomRef || !currentSet) return;
    const idx = (round) % currentSet.questions.length;
    const q = currentSet.questions[idx];
    round++;

    await updateDoc(roomRef, {
      status: "question",
      round,
      question: { n: round, q: q.q, choices: q.choices, answerIndex: q.correct }
    });

    // score answers as they arrive for this round
    if(stopAnswers) stopAnswers();
    const answersQ = query(collection(roomRef,"answers"), where("round","==", round));
    stopAnswers = onSnapshot(answersQ, (snap)=>{
      snap.docChanges().forEach(ch=>{
        if(ch.type!=="added") return;
        const ansRef = ch.doc.ref;
        runTransaction(db, async (tx)=>{
          const ansSnap = await tx.get(ansRef);
          const ans = ansSnap.data(); if(!ans || ans.processed===true) return;

          const roomSnap = await tx.get(roomRef);
          const data = roomSnap.data(); if(!data || !data.question || data.question.n!==ans.round) return;

          const correct = ans.choiceIndex === data.question.answerIndex;
          const playerRef = doc(roomRef,"players", ans.playerId);
          const playerSnap = await tx.get(playerRef);
          if(!playerSnap.exists()) return;

          const cur = playerSnap.data().score||0;
          tx.update(playerRef, { score: cur + (correct?1:0) });
          tx.update(ansRef, { processed:true, correct });
        });
      });
    });
  }catch(err){ showErr("Next Question failed: "+err.message); }
};

/* ---------- Utils ---------- */
function genCode(len=6){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out=""; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])) }

/* Surface unexpected errors to the red box */
addEventListener('error', e=> showErr(`Script error: ${e.message}`));
addEventListener('unhandledrejection', e=> showErr(`Promise error: ${e.reason?.message||e.reason}`));
</script>
</body>
</html>
