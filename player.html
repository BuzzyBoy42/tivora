<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tivora — Player</title>
<style>
  :root{--bg:#faf7ff;--panel:#fff;--ink:#0b0d18;--muted:#6b7280;--border:#ebe8f2;--accent:#6e4cff;--radius:16px;--shadow:0 10px 30px rgba(20,20,40,.06)}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:600 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  main{max-width:760px;margin:22px auto;padding:0 16px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  input,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent);cursor:pointer}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .big{font-size:20px}
  .choices{display:grid;gap:8px}
  .choice{padding:12px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:#fff}
  .choice.submitted{opacity:.6;pointer-events:none}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
</style>
</head>
<body>
<main>
  <section class="card" id="joinCard">
    <h2>Join a Game</h2>
    <div class="row">
      <input id="name" placeholder="Your name" />
      <input id="code" placeholder="6-digit code" maxlength="8" />
      <button id="joinBtn" class="primary">Join</button>
    </div>
    <div class="muted">Ask your host for the code. If you refresh, you should reconnect automatically.</div>
  </section>

  <section class="card" id="gameCard" style="display:none">
    <div class="row"><div class="muted">Room <b id="roomLabel">—</b></div><div class="muted">•</div><div class="muted">Player <b id="playerLabel">—</b></div></div>
    <div class="big" id="qTitle">Waiting for the host…</div>
    <div class="choices" id="choices"></div>
    <div class="muted" id="statusLine"></div>
  </section>

  <section class="card" id="finalCard" style="display:none">
    <h2>Final Leaderboard</h2>
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead>
      <tbody id="finalBody"></tbody>
    </table>
    <div class="row"><button id="leaveBtn">Leave Room</button></div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, onSnapshot, addDoc, collection,
  serverTimestamp, query, orderBy, getDocs
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* TODO: Replace with your Firebase project values */
const firebaseConfig = {
  apiKey: "PASTE",
  authDomain: "PASTE.firebaseapp.com",
  projectId: "PASTE",
  storageBucket: "PASTE.appspot.com",
  messagingSenderId: "PASTE",
  appId: "PASTE"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const $ = s=>document.querySelector(s);
const ui = {
  joinCard: $("#joinCard"),
  name: $("#name"),
  code: $("#code"),
  joinBtn: $("#joinBtn"),
  gameCard: $("#gameCard"),
  roomLabel: $("#roomLabel"),
  playerLabel: $("#playerLabel"),
  qTitle: $("#qTitle"),
  choices: $("#choices"),
  statusLine: $("#statusLine"),
  finalCard: $("#finalCard"),
  finalBody: $("#finalBody"),
  leaveBtn: $("#leaveBtn")
};
const urlCode = new URLSearchParams(location.search).get("code");
if(urlCode){ ui.code.value = urlCode.toUpperCase(); }

let code=null, roomRef=null, playerId=null, playerRef=null, round=0, answeredRounds=new Set(), stopRoom=null;

function id24(){ return Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,10); }
function lsKey(c){ return `tivora_player_${c}`; }
async function ensurePlayerDoc(){
  const now = serverTimestamp();
  playerId = JSON.parse(localStorage.getItem(lsKey(code))||"null")?.id || id24();
  playerRef = doc(roomRef, "players", playerId);
  await setDoc(playerRef, { name: ui.name.value||"Player", score: 0, joinedAt: now }, { merge:true });
  localStorage.setItem(lsKey(code), JSON.stringify({ id: playerId, name: ui.name.value||"Player" }));
}

ui.joinBtn.onclick = async ()=>{
  code = ui.code.value.trim().toUpperCase();
  if(!/^[A-Z0-9]{4,8}$/.test(code)){ alert("Enter a valid 6-digit code."); return; }

  roomRef = doc(db, "rooms", code);
  const r = await getDoc(roomRef);
  if(!r.exists()){ alert("Room not found. Double-check the code."); return; }

  await ensurePlayerDoc();

  ui.roomLabel.textContent = code;
  ui.playerLabel.textContent = (ui.name.value||"Player");
  ui.joinCard.style.display="none";
  ui.gameCard.style.display="";

  stopRoom = onSnapshot(roomRef, snap=>{
    const data = snap.data(); if(!data) return;

    if(data.status==="ended"){ showFinal(); return; }

    round = data.round|0;
    if(data.status==="question" && data.question){
      const q = data.question;
      ui.qTitle.textContent = `Q${q.n}: ${q.q}`;
      ui.choices.innerHTML = "";
      ui.statusLine.textContent = "";

      q.choices.forEach((text, i)=>{
        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = text;
        b.onclick = async ()=>{
          Array.from(ui.choices.children).forEach(c=>c.classList.add("submitted"));
          ui.statusLine.textContent = "Answer submitted!";
          if(answeredRounds.has(q.n)) return;
          answeredRounds.add(q.n);
          await addDoc(collection(roomRef, "answers"), {
            round: q.n,
            playerId,
            choiceIndex: i,
            name: (ui.name.value||"Player"),
            createdAt: serverTimestamp()
          });
        };
        ui.choices.appendChild(b);
      });
    } else {
      ui.qTitle.textContent = "Waiting for the host…";
      ui.choices.innerHTML = "";
      ui.statusLine.textContent = "";
    }
  });
};

async function showFinal(){
  ui.gameCard.style.display="none";
  const rows = [];
  const snap = await getDocs(query(collection(roomRef,"players"), orderBy("score","desc"))).catch(()=>null);
  if(snap){ snap.forEach(d=>rows.push({id:d.id, ...d.data()})) }
  ui.finalBody.innerHTML = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${(r.name||"Player").replace(/</g,"&lt;")}</td><td>${r.score||0}</td></tr>`).join("");
  ui.finalCard.style.display="";
}

ui.leaveBtn.onclick = ()=>{
  localStorage.removeItem(lsKey(code));
  location.href = "./index.html";
};

(function autoRejoin(){
  const urlC = ui.code.value.trim().toUpperCase();
  const saved = urlC && JSON.parse(localStorage.getItem(lsKey(urlC))||"null");
  if(saved){ ui.name.value = saved.name||""; }
})();
</script>
</body>
</html>
